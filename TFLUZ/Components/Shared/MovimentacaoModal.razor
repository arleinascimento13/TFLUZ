@using System.ComponentModel.DataAnnotations
@using TFLUZ.Application.DTO
@using TFLUZ.Core.Models

<EditForm Model="@model" OnValidSubmit="@Salvar">
    <DataAnnotationsValidator />
    @* <ValidationSummary /> *@

    <div class="row g-3">

        <!-- Valor -->
        <div class="col-12">
            <label class="form-label">Valor da movimentação:</label>
            <CurrencyInput @bind-Value="model.Valor"
                           TValue="decimal"
                           Locale="pt-BR"
                           Disabled="SomenteLeitura" />
            <ValidationMessage For="@(() => model.Valor)" />
        </div>

        <!-- Data -->
        <div class="col-12">
            <label class="form-label">Data:</label>
            <DateInput @bind-Value="model.Data"
                       TValue="DateTime"
                       Disabled="SomenteLeitura" />
            <ValidationMessage For="@(() => model.Data)" />
        </div>

        <!-- Descrição -->
        @* <div class="col-12">
            <label class="form-label">Descrição:</label>

            <Dropdown>
                <DropdownToggleButton>
                    @(string.IsNullOrEmpty(model.Descricao)
                                        ? "Selecione um item"
                                        : model.Descricao)
                </DropdownToggleButton>

                <DropdownMenu>
                    @foreach (var item in listaItens)
                    {
                        <DropdownItem Type="DropdownItemType.Button"
                                      @onclick="() => SelecionarItem(item)">
                            @item
                        </DropdownItem>
                    }
                </DropdownMenu>
            </Dropdown>

            <ValidationMessage For="@(() => model.Descricao)" />
        </div> *@

        <!-- Observação -->
        <div class="col-12">
            <label class="form-label">Observação:</label>
            <TextAreaInput Label="Observação"
                           @bind-Value="model.Observacao"
                           MaxLength="500"
                           Rows="3"
                           Disabled="SomenteLeitura"></TextAreaInput>
            <ValidationMessage For="@(() => model.Observacao)" />
        </div>

        <!-- Status -->
        <div class="col-12">
            <CheckboxInput Label="Pendente?"
                           Id="pendenteCheck"
                           Disabled="SomenteLeitura"
                           @bind-Value="model.Pendente" />
        </div>
    </div>
</EditForm>

@code {
    // parâmetros do modal
    [Parameter] public string Title { get; set; }
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback OnOpen { get; set; }
    [Parameter] public EventCallback<Movimentacao> OnSave { get; set; }
    [Parameter] public bool SomenteLeitura { get; set; }

    private MovimentacaoRequestDTO model = new MovimentacaoRequestDTO();

    // campos do formulário
    private DateTime Data = DateTime.Now;
    private decimal? Valor = null;
    private bool ehPendente = false;
    private string Observacao = "";
    private string itemSelecionado;

    // private void SelecionarItem(string item)
    // {
    //     itemSelecionado = item;
    // }

    public async Task Salvar()
    {
        if (SomenteLeitura)
            return;

        var nova = new Movimentacao
        {
            Data = model.Data,
            Valor = model.Valor,
            Observacao = model.Observacao,
            Status = new StatusMovimentacao
            {
                Nome = model.Pendente ? "Pendente" : "Finalizada"
            },
            Classificacao = model.Valor >= 0
                ? TipoClassificacaoMovimentacao.Receita
                : TipoClassificacaoMovimentacao.Despesa
        };

        await OnSave.InvokeAsync(nova);
    }

    public async Task PreencherDados(Movimentacao mov)
    {
        if (mov == null) return;

        model = new MovimentacaoRequestDTO
        {
            Data = mov.Data,
            Valor = mov.Valor,
            Observacao = mov.Observacao,
            Pendente = mov.Status?.Nome == "Pendente"
        };

        await InvokeAsync(StateHasChanged);
    }

    public void Limpar()
    {
        model = new MovimentacaoRequestDTO();
    }
}
