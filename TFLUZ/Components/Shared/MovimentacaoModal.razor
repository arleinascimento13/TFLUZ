@using System.ComponentModel.DataAnnotations
@using TFLUZ.Core.Models

<EditForm Model="@Model" OnValidSubmit="@Salvar">
    <DataAnnotationsValidator />

    <div class="row g-3">
        <!-- Valor -->
        <div class="col-12">
            <label class="form-label">Valor da movimentação:</label>
            <CurrencyInput @bind-Value="Model.Valor"
                           TValue="decimal"
                           Locale="pt-BR"
                           Disabled="SomenteLeitura" />
            <ValidationMessage For="@(() => Model.Valor)" />
        </div>

        <!-- Data -->
        <div class="col-12">
            <label class="form-label">Data:</label>
            <DateInput @bind-Value="Model.Data"
                       TValue="DateTime"
                       Disabled="SomenteLeitura" />
            <ValidationMessage For="@(() => Model.Data)" />
        </div>

        <!-- Status (usando Descricoes) -->
        <div class="col-12">
            <label class="form-label">Descrição:</label>

            <Dropdown Disabled="SomenteLeitura">
                <DropdownToggleButton>@(itemSelecionado == 0 ? "Selecione um status" : ObterNome(itemSelecionado))</DropdownToggleButton>
                <DropdownMenu>
                    @if (Descricoes is not null)
                    {
                        @foreach (var item in Descricoes)
                        {
                            <DropdownItem Type="DropdownItemType.Button"
                                          @onclick="() => SelecionarItem(item.Id)">
                                @item.Nome
                            </DropdownItem>
                        }
                    }
                    else
                    {
                        <DropdownItem Type="DropdownItemType.Button" Disabled="true">
                            Carregando...
                        </DropdownItem>
                    }
                </DropdownMenu>
            </Dropdown>
        </div>

        <!-- Observação -->
        <div class="col-12">
            <label class="form-label">Observação:</label>
            <TextAreaInput @bind-Value="Model.Observacao"
                           MaxLength="500"
                           Rows="3"
                           Disabled="SomenteLeitura"></TextAreaInput>
            <ValidationMessage For="@(() => Model.Observacao)" />
        </div>
    </div>
</EditForm>

@code {
    // parâmetros do modal
    [Parameter] public bool SomenteLeitura { get; set; }
    [Parameter] public EventCallback<Movimentacao> OnSave { get; set; }
    [Parameter] public List<DescricaoMovimentacao> Descricoes { get; set; }

    private Movimentacao Model = new Movimentacao();
    private int itemSelecionado;

    protected override Task OnParametersSetAsync()
    {
        // garante consistência quando Descricoes ou SomenteLeitura mudar
        if (SomenteLeitura)
        {
            // evite mudanças no model quando em leitura
        }
        else
        {
            // se não há item selecionado ainda e existem descrições, selecione padrão (opcional)
            // if (itemSelecionado == 0 && Descricoes is { Count: > 0 })
            //     itemSelecionado = Descricoes.First().Id;
        }

        return Task.CompletedTask;
    }

    private void SelecionarItem(int id)
    {
        itemSelecionado = id;

        // se sua Movimentacao tem vínculo com Descricao:
        // Model.DescricaoMovimentacaoId = id; // exemplo
        // ou se o "Status" é derivado do item selecionado:
        // Model.Status = Descricoes?.FirstOrDefault(x => x.Id == id)?.Nome;
    }

    private string ObterNome(int id) =>
        Descricoes?.FirstOrDefault(x => x.Id == id)?.Nome ?? "Selecione um status";

    public async Task Salvar()
    {
        if (SomenteLeitura)
            return;

        var nova = new Movimentacao
        {
            Data = Model.Data,
            Valor = Model.Valor,
            Observacao = Model.Observacao,
            Status = Model.Status,
            Classificacao = Model.Classificacao,
            // Ex.: vincular descrição selecionada
            // DescricaoMovimentacaoId = itemSelecionado
        };

        await OnSave.InvokeAsync(nova);
    }

    public async Task PreencherDados(Movimentacao mov)
    {
        if (mov == null) return;

        Model = new Movimentacao
        {
            Data = mov.Data,
            Valor = mov.Valor,
            Observacao = mov.Observacao,
            Status = mov.Status,
            Classificacao = mov.Classificacao
        };

        // se o mov tem uma descrição vinculada, sincronize o dropdown:
        // itemSelecionado = mov.DescricaoMovimentacaoId;

        await InvokeAsync(StateHasChanged);
    }

    public void Limpar()
    {
        Model = new Movimentacao();
        itemSelecionado = 0;
    }
}
